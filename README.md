*   **22.01 – 28.01:** Создание БД, подключение (`db.php`), вывод данных.
*   **29.01 – 04.02:** Формы регистрации/входа, сессии.
*   **05.02:** Вероятно, админ-панель или редактирование записей.

**Проблема:** Код в репозиториях, скорее всего, написан в процедурном стиле (смесь HTML и PHP, «лапша»), что допустимо для лабораторных, но **недопустимо** для финальной Курсовой работы по ПМ.09 (требуется модульность/MVC и безопасность).

***

**Тема:** Рефакторинг лабораторных наработок в архитектуру Курсового Проекта. Аудит уязвимостей.
**Дата:** 11.02.2026 (Среда).
**Основание:** Код из репозиториев за 04.02–05.02 (CRUD/Auth) и Методические указания (ПМ.09).

---

## ПАРА 1. ОТ «ЛАБОРАТОРНОЙ» К «КУРСОВОЙ» (АРХИТЕКТУРА) (13:20 – 14:50)

### 1. Ситуация «Как есть» (Review)
В ваших репозиториях от 05.02 (Auth/CRUD) логика перемешана с версткой.
*   *Типичная ошибка:* `if ($_POST) { ...header('Location: ...'); }` написано прямо перед тегом `<html>`.
*   *Требование Курсовой (ПМ.09):* Разделение ответственности (MVC или хотя бы Separation of Concerns).

### 2. Практическое задание: «Великое разделение»
**Задача:** Превратить код из лабораторной от 05.02 в структуру курсового проекта.

#### Шаг 1. Создание структуры папок (Стандартизация)
В корне проекта (локально) создайте папки:
*   `/config` — сюда переместить `db.php` (настройки подключения).
*   `/templates` (или `/views`) — сюда перенести ВСЮ верстку (`.html` / `.php` с HTML), убрав из них SQL-запросы.
*   `/core` (или `/src`) — здесь будут функции/классы.
*   `index.php` — единая точка входа (Router).

#### Шаг 2. Вынос логики (Refactoring Live)
*Инструкция:*
1.  Откройте ваш файл регистрации (из репо `04.02.2026`).
2.  Вырежьте PHP-код обработки формы.
3.  Вставьте его в `actions/register.php`.
4.  HTML-форму сохраните в `templates/register_form.php`.
5.  В `index.php` подключите логику:
    ```php
    // Пример примитивного роутера для курсовой
    $page = $_GET['page'] ?? 'home';
    if ($page == 'register') {
        require 'actions/register.php'; // Логика
        require 'templates/register_form.php'; // Вид
    }
    ```

# РАЗДЕЛ 2 (РАСШИРЕННЫЙ). РЕФАКТОРИНГ: ОТ ПРОЦЕДУР К ООП И MVC

## ЧАСТЬ А. ТЕОРЕТИЧЕСКИЙ БАЗИС (Лекционный блок — 20 минут)

Перед тем как править код, студент должен понять, **зачем** это нужно, чтобы защитить архитектуру в Пояснительной Записке (Глава 2.2).

### 1. Почему ваш текущий код (от 05.02) плох?
В репозиториях сейчас наблюдается **Code Smell** (Запах кода):
*   **Смешение ответственности:** В одном файле `register.php` происходит подключение к БД, валидация `$_POST`, бизнес-логика и вывод HTML.
*   **Глобальное состояние:** Переменные `$conn` или `$link` гуляют по всему проекту.
*   **Невозможность масштабирования:** Чтобы добавить «Фишку» (например, API для мобильного приложения), придется переписывать весь код.

### 2. Три кита ООП в контексте ПМ.09
1.  **Инкапсуляция:** Данные (пароль пользователя, баланс) и методы работы с ними (хеширование, списание) живут внутри одного Класса. Никто снаружи не может изменить баланс, минуя метод `makeTransaction()`.
2.  **Наследование:** У вас есть `User`. Админ — это тоже `User`, но с правами. `class Admin extends User`.
3.  **Полиморфизм:** Методу `login($user)` все равно, кто пришел — Клиент или Менеджер. Он работает с абстракцией.

### 3. Паттерн MVC (Model-View-Controller)
Это **обязательный стандарт** для оценки «Отлично» на защите.
*   **Model (Модель):** «Повар». Работает с Базой Данных. Знает, как сохранить пользователя, как достать товары. Ничего не знает о HTML.
*   **View (Вид/Представление):** «Официант с подносом». Красивая HTML-верстка. Не содержит логики (максимум `foreach`).
*   **Controller (Контроллер):** «Метрдотель». Принимает заказ от клиента (Роутера), говорит Модели «Дай данные», отдает их Виду.

---

## ЧАСТЬ Б. ПРАКТИЧЕСКАЯ ИНСТРУКЦИЯ ПО РЕФАКТОРИНГУ

**Стек:** PHP 8.2+ (Строгая типизация), PDO.
**Инструмент:** VS Code.

### Шаг 0. Подготовка структуры (File Structure)
Создайте следующую иерархию папок. Это стандарт PSR (упрощенный):
```text
/project-root
├── /config
│   └── Database.php      <-- Обертка над PDO (Singleton)
├── /src
│   ├── /Models           <-- Классы: User.php, Product.php
│   ├── /Controllers      <-- Классы: UserController.php
│   └── /Views            <-- Шаблонизатор (View.php)
├── /templates            <-- Ваши HTML файлы из прошлых лаб
│   ├── header.php
│   └── register.php
└── index.php             <-- Единая точка входа
```

### Шаг 1. Singleton для Базы Данных (Config)
Убираем `mysqli_connect`. Пишем профессиональный класс на PDO.
*Файл: `config/Database.php`*

```php
<?php
class Database {
    private static ?PDO $instance = null;

    // Закрываем конструктор, чтобы нельзя было создать new Database()
    private function __construct() {}

    public static function getConnection(): PDO {
        if (self::$instance === null) {
            $config = require 'config.php'; // Файл с паролями
            $dsn = "mysql:host={$config['host']};dbname={$config['db']};charset=utf8";
            
            self::$instance = new PDO($dsn, $config['user'], $config['pass']);
            // Включаем режим исключений (важно для отлова ошибок)
            self::$instance->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
            // Режим выборки по умолчанию - ассоциативный массив
            self::$instance->setAttribute(PDO::ATTR_DEFAULT_FETCH_MODE, PDO::FETCH_ASSOC);
        }
        return self::$instance;
    }
}
```

### Шаг 2. Создание Модели (Model)
Превращаем SQL-запросы в методы класса.
*Пример для студента Агапова (LMS) или Лещинского (Инвентаризация).*
*Файл: `src/Models/User.php`*

```php
<?php
class User {
    private PDO $db;

    public function __construct() {
        $this->db = Database::getConnection();
    }

    // Регистрация (CRUD - Create)
    public function create(string $email, string $password, string $name): bool {
        // Защита от SQL Injection: Prepared Statements
        $sql = "INSERT INTO users (name, email, password_hash) VALUES (:name, :email, :hash)";
        $stmt = $this->db->prepare($sql);
        
        return $stmt->execute([
            ':name' => $name,
            ':email' => $email,
            ':hash' => password_hash($password, PASSWORD_DEFAULT)
        ]);
    }

    // Поиск (CRUD - Read)
    public function findByEmail(string $email): ?array {
        $stmt = $this->db->prepare("SELECT * FROM users WHERE email = :email");
        $stmt->execute([':email' => $email]);
        $result = $stmt->fetch();
        return $result ?: null; // Возвращаем массив или null
    }
}
```

### Шаг 3. Создание Контроллера (Controller)
Контроллер управляет потоком. Он не работает с SQL напрямую!
*Файл: `src/Controllers/AuthController.php`*

```php
<?php
require_once __DIR__ . '/../Models/User.php';

class AuthController {
    
    public function register() {
        // Если пришли данные POST
        if ($_SERVER['REQUEST_METHOD'] === 'POST') {
            $name = $_POST['name'] ?? '';
            $email = $_POST['email'] ?? '';
            $pass = $_POST['password'] ?? '';

            // Валидация (Минимум действий)
            if (empty($email) || empty($pass)) {
                die("Заполните поля!"); 
            }

            $userModel = new User();
            // Проверка на дубликат
            if ($userModel->findByEmail($email)) {
                die("Такой email уже занят");
            }

            // Создание
            if ($userModel->create($email, $pass, $name)) {
                header('Location: /?page=login&success=1');
                exit;
            }
        }

        // Если GET запрос - просто показываем форму
        require_once __DIR__ . '/../../templates/register.php';
    }
}
```

### Шаг 4. Точка входа (Router)
Все запросы идут через `index.php`. Это позволяет управлять безопасностью централизованно.
*Файл: `index.php`*

```php
<?php
// В идеале здесь должен быть Autoloader, но для понимания пишем require
require_once 'config/Database.php';
require_once 'src/Controllers/AuthController.php';

// Простейший роутинг
$page = $_GET['page'] ?? 'home';

switch ($page) {
    case 'register':
        $controller = new AuthController();
        $controller->register();
        break;
        
    case 'login':
        // TODO: Реализовать LoginController
        break;
        
    default:
        echo "<h1>Добро пожаловать в Курсовой Проект</h1>";
        echo "<a href='?page=register'>Регистрация</a>";
        break;
}
```

---

## ЧАСТЬ В. САМОПРОВЕРКА (CHECKLIST)

Студент должен проверить свой обновленный код по пунктам:

1.  [ ] **Нет `global`:** В методах не используется ключевое слово `global`. Соединение с БД передается через конструктор или Singleton.
2.  [ ] **Нет SQL в HTML:** В файлах папки `/templates` нет ни одного `INSERT`, `SELECT` или `UPDATE`. Только вывод переменных `<?= $name ?>`.
3.  [ ] **Type Hinting:** У всех функций указаны типы аргументов (`string $email`) и возвращаемых значений (`: bool`).
4.  [ ] **Безопасность:** Используется `prepare()` и `execute()` (PDO), а не прямая вставка переменных в строку запроса.

***

#### Шаг 3. Интеграция «Фишки» (Индивидуально)
*   **Дмитриев (Тема 6, Автосервис):** Ваш календарь занятости боксов не должен быть «зашит» в HTML. Создайте API-endpoint (файл `api/get_slots.php`), который отдает JSON. JS на фронтенде должен забирать эти данные.
*   **Белозерцева (Тема 3, Фриланс):** Разделение ролей (Заказчик/Исполнитель) должно проверяться в **одном** месте (Middleware), а не в каждом файле. Создайте функцию `checkRole('admin')` и внедрите ее.

---

## ПАРА 2. SELF-HACKING: АУДИТ ТОГО, ЧТО НАПИСАЛИ (16:50 – 18:20)

### 1. Проверка на SQL Injection (Критично!)
В лабораторных от 28.01 вы, скорее всего, использовали простые запросы.
**Тест:** В поле «Логин» или «Поиск» введите: `' OR '1'='1`
*   Если вы вошли как админ или увидели все товары — **Проект не допущен к защите**.

**Исправление (Прямо на паре):**
Переписать все запросы `mysqli_query` на `PDO` (Prepared Statements).
*   *Было:* `SELECT * FROM users WHERE name = '$name'`
*   *Стало:*
    ```php
    $stmt = $pdo->prepare('SELECT * FROM users WHERE name = :name');
    $stmt->execute(['name' => $_POST['name']]);
    ```

### 2. Проверка XSS (Безопасность вывода)
В репозитории `05.02.2026` вы делали вывод данных (имя пользователя, список товаров).
**Тест:** Создайте товар/пользователя с именем: `<script>alert('Pwned')</script>`
*   Если при просмотре списка всплыло окно — **Незачет по МДК.09.03**.

**Исправление:** Обернуть весь вывод в `htmlspecialchars($var)`.

### 3. Настройка .gitignore
Перед загрузкой обновленной версии на GitHub проверьте файл `.gitignore`.
**Обязательно добавить:**
*   `/vendor` (если есть Composer)
*   `.idea`, `.vscode` (мусор IDE)
*   **CRITICAL:** Файл с паролями БД (если он отличается от локального). *Лучшая практика для курсовой: пример конфига `config.example.php` залит, а боевой `config.php` — в игноре.*

---

## ПАРА 3. ДОКУМЕНТИРОВАНИЕ КОДА (ПЗ) (12:30 – 14:05)

### 1. Связь кода и текста
Открываем шаблон Пояснительной Записки (из PDF).
**Задача:** Написать раздел **1.3 Обоснование средств разработки** и **2.1 Разработка базы данных**.

### 2. Генерация описания БД (Reverse Engineering)
У вас уже есть таблицы (созданные на парах 22.01–29.01).
1.  Зайдите в phpMyAdmin (или DBeaver).
2.  Сделайте экспорт схемы («Дизайнер» -> Скриншот связи таблиц).
3.  Вставьте в ПЗ как «Рисунок 1. ER-диаграмма базы данных».
4.  Опишите текстом:
    *   *«Таблица `users` предназначена для хранения... Поля: `id` (PK), `login`...»*
    *   *«Таблица `orders` связана с `users` через внешний ключ `user_id`...»*

### 3. Валидация функционала по Ведомости
Студенты открывают файл `207-1_Random_4570724.html` (Ведомость).
**Задание:** Написать в ПЗ (Глава 2.2), как *технически* реализована ваша «Фишка».
*   *Пример (Агапов, Прогресс-бар):* «Для реализации прогресс-бара (Тема 4) была создана таблица `user_progress` (user_id, lesson_id, status). Расчет процента производится SQL-запросом `COUNT(*)...`».

### 4. Домашнее задание (Deadline: 18.02)
1.  Запушить рефакторинг (папки `views/`, `config/`) в Git.
2.  Подключить SonarCloud к репозиторию и исправить ошибки уровня "High".
3.  Принести распечатанное Введение и Главу 1.

***
